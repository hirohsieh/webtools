<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR æƒæå™¨ - å»ºç«‹æ¸…å–®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            background-color: #0f172a; /* slate-900 */
            color: #f1f5f9; /* slate-100 */
        }
        #reader {
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid #1e293b !important; /* slate-800 */
        }
        #reader__dashboard_section_csr button {
            background-color: #3b82f6 !important;
            color: white !important;
            padding: 10px 20px !important;
            border-radius: 10px !important;
            font-weight: 600 !important;
            transition: all 0.2s !important;
        }
        #reader__dashboard_section_csr button:hover {
            opacity: 0.9 !important;
            transform: scale(0.98);
        }
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
        }
    </style>
</head>
<body class="min-h-screen font-sans">
    <div class="max-w-md mx-auto p-5 pb-28">
        <header class="mb-8 mt-4">
            <h1 class="text-3xl font-black bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">QR Scanner</h1>
            <p class="text-slate-400 text-sm mt-1">é€£çºŒæƒæå¤šå€‹æ¢ç¢¼ä¸¦è¨­å®šæ¨™é¡Œ</p>
        </header>

        <!-- æƒæå€åŸŸ -->
        <div class="bg-slate-800/50 p-2 rounded-2xl border border-slate-700/50 shadow-2xl mb-8">
            <div id="reader"></div>
        </div>

        <!-- åˆ—è¡¨ -->
        <div id="resultsList" class="space-y-4">
            <!-- é …ç›®å°‡é¡¯ç¤ºæ–¼æ­¤ -->
        </div>

        <div id="emptyState" class="text-center py-16 text-slate-600">
            <div class="text-6xl mb-4 opacity-20">ğŸ“¸</div>
            <p class="font-medium">å°šæœªæƒæä»»ä½•å…§å®¹</p>
        </div>
    </div>

    <!-- åº•éƒ¨åŠŸèƒ½åˆ— -->
    <div class="fixed bottom-0 left-0 right-0 bg-slate-900/80 backdrop-blur-lg border-t border-slate-800 p-5 z-20">
        <div class="max-w-md mx-auto flex gap-3">
            <button id="generateBtn" class="flex-1 bg-blue-600 hover:bg-blue-500 active:scale-95 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-900/20 transition-all disabled:opacity-30 disabled:grayscale disabled:cursor-not-allowed" disabled>
                Generate URL
            </button>
            <button id="clearBtn" class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-6 py-4 rounded-2xl transition-all border border-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
            </button>
        </div>
    </div>

    <!-- æˆåŠŸå½ˆçª— -->
    <div id="resultModal" class="fixed inset-0 modal-bg z-50 flex items-center justify-center p-6 hidden">
        <div class="bg-slate-800 w-full max-w-sm rounded-[2rem] shadow-2xl border border-slate-700 overflow-hidden">
            <div class="p-8 text-center">
                <div class="w-20 h-20 bg-green-500/10 text-green-400 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2">ç¶²å€å·²ç”Ÿæˆ</h3>
                <p class="text-slate-400 text-sm mb-6">æ‚¨çš„ QR æ¸…å–®å·²æº–å‚™å°±ç·’ï¼Œæ‚¨å¯ä»¥é»æ“Šä¸‹æ–¹æŒ‰éˆ•é è¦½ã€‚</p>
                
                <textarea id="generatedUrlOutput" readonly class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-xs text-slate-400 mb-6 h-24 resize-none focus:outline-none font-mono"></textarea>
                
                <div class="grid grid-cols-1 gap-3">
                    <button id="goToUrlBtn" class="w-full bg-white text-slate-900 hover:bg-blue-50 font-black py-4 rounded-2xl transition-all shadow-xl">
                        ç«‹å³å‰å¾€ (Open)
                    </button>
                    <button id="copyUrlBtn" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 rounded-2xl transition-all">
                        è¤‡è£½ç¶²å€ (Copy)
                    </button>
                    <button id="closeModalBtn" class="w-full text-slate-500 text-sm py-2 hover:text-slate-300 transition-colors mt-2">
                        å›åˆ—è¡¨ç¹¼çºŒæƒæ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-8 py-3 rounded-full text-sm font-bold shadow-2xl opacity-0 transition-all pointer-events-none z-[60] transform -translate-y-4">
        Toast Message
    </div>

    <script>
        const DISPLAY_BASE_URL = "qrdisplay.html";
        let scannedItems = [];
        const html5QrCode = new Html5Qrcode("reader");
        const resultsList = document.getElementById('resultsList');
        const emptyState = document.getElementById('emptyState');
        const generateBtn = document.getElementById('generateBtn');
        const toast = document.getElementById('toast');
        const resultModal = document.getElementById('resultModal');
        const generatedUrlOutput = document.getElementById('generatedUrlOutput');
        const goToUrlBtn = document.getElementById('goToUrlBtn');
        const copyUrlBtn = document.getElementById('copyUrlBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');

        function showToast(msg) {
            toast.innerText = msg;
            toast.classList.remove('opacity-0', '-translate-y-4');
            toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', '-translate-y-4');
            }, 2000);
        }

        function updateUI() {
            if (scannedItems.length === 0) {
                emptyState.classList.remove('hidden');
                generateBtn.disabled = true;
                resultsList.innerHTML = '';
            } else {
                emptyState.classList.add('hidden');
                generateBtn.disabled = false;
                renderList();
            }
        }

        function renderList() {
            resultsList.innerHTML = scannedItems.map((item, index) => `
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700/50 shadow-sm relative group animate-in fade-in slide-in-from-bottom-2 duration-300">
                    <button onclick="removeItem(${index})" class="absolute top-4 right-4 text-slate-500 hover:text-red-400 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                    <div class="mb-4">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-1">æ¨™é¡Œ</label>
                        <input type="text" 
                            value="${item.title}" 
                            placeholder="è¼¸å…¥æ¨™é¡Œ" 
                            onchange="updateTitle(${index}, this.value)"
                            class="w-full bg-transparent text-lg font-bold text-white border-b-2 border-slate-700 focus:border-blue-500 outline-none pb-1 transition-colors"
                        >
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-1">å…§å®¹</label>
                        <div class="text-sm text-slate-400 break-all bg-slate-900/50 p-3 rounded-xl font-mono border border-slate-700/30">${item.data}</div>
                    </div>
                </div>
            `).join('');
        }

        function updateTitle(index, val) {
            scannedItems[index].title = val;
        }

        function removeItem(index) {
            scannedItems.splice(index, 1);
            updateUI();
        }

        function onScanSuccess(decodedText) {
            if (scannedItems.some(item => item.data === decodedText)) {
                showToast("æ­¤å…§å®¹å·²åœ¨æ¸…å–®ä¸­");
                return;
            }
            scannedItems.push({
                title: `é …ç›® ${scannedItems.length + 1}`,
                data: decodedText
            });
            showToast("æƒææˆåŠŸï¼");
            updateUI();
        }

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                resultsList.innerHTML = `<div class="p-6 bg-red-500/10 text-red-400 rounded-2xl text-center border border-red-500/20 font-bold">ç„¡æ³•å­˜å–ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™</div>`;
            });

        generateBtn.addEventListener('click', () => {
            if (scannedItems.length === 0) return;
            const jsonData = JSON.stringify(scannedItems);
            const encodedData = btoa(unescape(encodeURIComponent(jsonData)));
            const finalUrl = `${DISPLAY_BASE_URL}?payload=${encodedData}`;
            generatedUrlOutput.value = finalUrl;
            resultModal.classList.remove('hidden');
        });

        goToUrlBtn.addEventListener('click', () => {
            window.location.href = generatedUrlOutput.value;
        });

        copyUrlBtn.addEventListener('click', () => {
            generatedUrlOutput.select();
            document.execCommand('copy');
            showToast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
        });

        closeModalBtn.addEventListener('click', () => {
            resultModal.classList.add('hidden');
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æƒæç´€éŒ„å—ï¼Ÿ")) {
                scannedItems = [];
                updateUI();
            }
        });

        window.onload = updateUI;
    </script>
</body>
</html>
