<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR 顯示器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            overscroll-behavior: none; /* 禁用彈性滾動 */
            background-color: #0f172a; /* slate-900 */
            color: #f1f5f9; /* slate-100 */
            position: fixed; /* 防止 iOS 橡皮筋效應 */
            width: 100%;
            height: 100%;
        }
        .carousel-container {
            width: 100vw;
            overflow: hidden;
            touch-action: none; /* 重要：完全交給 JS 處理，避免 Safari 預設手勢干擾 */
            position: relative;
        }
        .carousel-track {
            display: flex;
            width: 100%;
            transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            will-change: transform;
        }
        .qr-card {
            flex: 0 0 100vw;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            box-sizing: border-box;
        }
        .qr-wrapper {
            background-color: white;
            padding: 2rem;
            border-radius: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            border: 8px solid #1e293b; /* slate-800 */
        }
        .qr-wrapper img, .qr-wrapper canvas {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: auto;
        }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #334155; /* slate-700 */
            transition: all 0.4s ease;
        }
        .dot.active {
            background: #3b82f6; /* blue-500 */
            width: 24px;
            border-radius: 10px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-between py-12 overflow-hidden">

    <!-- 頂部標題區 -->
    <div class="w-full px-8 text-center animate-in fade-in slide-in-from-top-4 duration-700">
        <h2 id="currentTitle" class="text-3xl font-black mb-2 truncate min-h-[2.5rem] bg-gradient-to-b from-white to-slate-400 bg-clip-text text-transparent italic">載入中...</h2>
        <div id="counter" class="inline-block px-4 py-1 rounded-full bg-slate-800 border border-slate-700 text-slate-400 text-xs font-bold tracking-widest">0 / 0</div>
    </div>

    <!-- 主展示區 -->
    <div class="carousel-container my-auto" id="carouselContainer">
        <div id="carouselTrack" class="carousel-track">
            <!-- 卡片 -->
        </div>
    </div>

    <!-- 底部導覽區 -->
    <div class="flex flex-col items-center gap-8 w-full pb-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
        <div id="dotsContainer" class="flex gap-2.5">
            <!-- 指示點 -->
        </div>
        
        <div class="flex items-center gap-3 text-slate-600 text-[10px] font-black uppercase tracking-[0.3em]">
            <span class="w-8 h-px bg-slate-800"></span>
            <span class="animate-pulse">Swipe to Switch</span>
            <span class="w-8 h-px bg-slate-800"></span>
        </div>
    </div>

    <script>
        let items = [];
        let currentIndex = 0;
        let startX = 0;
        let isDragging = false;
        let startTime = 0;

        const container = document.getElementById('carouselContainer');
        const track = document.getElementById('carouselTrack');
        const currentTitle = document.getElementById('currentTitle');
        const counter = document.getElementById('counter');
        const dotsContainer = document.getElementById('dotsContainer');

        function parseUrl() {
            const params = new URLSearchParams(window.location.search);
            const payload = params.get('payload');
            
            if (!payload) {
                showError("網址缺少數據參數");
                return;
            }

            try {
                const decodedJson = decodeURIComponent(escape(atob(payload)));
                items = JSON.parse(decodedJson);
                
                if (!items || items.length === 0) {
                    showError("清單內沒有項目");
                    return;
                }
                
                initDisplay();
            } catch (e) {
                console.error("Parse Error:", e);
                showError("數據格式錯誤");
            }
        }

        function showError(msg) {
            currentTitle.innerText = "Error";
            currentTitle.className = "text-3xl font-black text-red-500 mb-2 italic";
            counter.innerText = "";
            track.innerHTML = `<div class="qr-card"><div class="bg-slate-800 p-10 rounded-3xl text-center border border-red-500/20 shadow-2xl">${msg}</div></div>`;
        }

        function initDisplay() {
            track.innerHTML = '';
            dotsContainer.innerHTML = '';

            items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'qr-card';
                
                const wrapper = document.createElement('div');
                wrapper.className = 'qr-wrapper';
                
                card.appendChild(wrapper);
                track.appendChild(card);

                new QRCode(wrapper, {
                    text: item.data,
                    width: 280,
                    height: 280,
                    colorDark : "#0f172a",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });

                const dot = document.createElement('div');
                dot.className = 'dot';
                dotsContainer.appendChild(dot);
            });

            updateView();
            setupTouchEvents();
        }

        function updateView() {
            track.style.transform = `translateX(-${currentIndex * 100}vw)`;
            
            currentTitle.classList.remove('animate-in', 'fade-in');
            void currentTitle.offsetWidth; 
            currentTitle.classList.add('animate-in', 'fade-in');
            
            currentTitle.innerText = items[currentIndex].title;
            counter.innerText = `${currentIndex + 1} / ${items.length}`;

            const dots = dotsContainer.querySelectorAll('.dot');
            dots.forEach((dot, idx) => {
                if (idx === currentIndex) dot.classList.add('active');
                else dot.classList.remove('active');
            });
        }

        function setupTouchEvents() {
            // 使用非 passive 監聽器以允許 preventDefault()
            container.addEventListener('touchstart', e => {
                startX = e.touches[0].clientX;
                startTime = Date.now();
                isDragging = true;
                track.style.transition = 'none';
            }, { passive: false });

            container.addEventListener('touchmove', e => {
                if (!isDragging) return;
                
                const currentX = e.touches[0].clientX;
                const diff = currentX - startX;
                
                // 當發生水平移動時，阻止瀏覽器行為（阻止 Safari 側滑返回）
                if (Math.abs(diff) > 5) {
                    if (e.cancelable) e.preventDefault();
                }

                const movePercent = (diff / window.innerWidth) * 100;
                const finalPos = (currentIndex * -100) + movePercent;
                track.style.transform = `translateX(${finalPos}vw)`;
            }, { passive: false });

            container.addEventListener('touchend', e => {
                if (!isDragging) return;
                isDragging = false;
                
                track.style.transition = 'transform 0.5s cubic-bezier(0.23, 1, 0.32, 1)';
                
                const endX = e.changedTouches[0].clientX;
                const diff = endX - startX;
                const duration = Date.now() - startTime;
                const threshold = window.innerWidth * 0.15;
                
                // 判斷是否為快速掃動 (Velocity check)
                const isFastSwipe = Math.abs(diff) > 30 && duration < 250;

                if ((diff < -threshold || (isFastSwipe && diff < 0)) && currentIndex < items.length - 1) {
                    currentIndex++;
                } else if ((diff > threshold || (isFastSwipe && diff > 0)) && currentIndex > 0) {
                    currentIndex--;
                }
                
                updateView();
            }, { passive: false });
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' && currentIndex > 0) {
                currentIndex--;
                updateView();
            } else if (e.key === 'ArrowRight' && currentIndex < items.length - 1) {
                currentIndex++;
                updateView();
            }
        });

        window.addEventListener('resize', updateView);
        window.onload = parseUrl;
    </script>
</body>
</html>
